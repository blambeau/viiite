# Bench &mdash; An alternative to Benchmark

After a first sketch a few weeks ago, I've decided to dedicate my *whyday* on Bench. Bench is an alternative to Benchmark, for handling more complex cases.

## Starting 'ala' Benchmark

Let's starts with the common Benchmark example. In Bench, this goes as follows:

```ruby
require 'bench/autorun'
n = 15000
Bench.runner do |r|
  r.report(:for)   { for i in 1..n; a = "1"; end }
  r.report(:times) { n.times do   ; a = "1"; end }
  r.report(:upto)  { 1.upto(n) do ; a = "1"; end }
end
```

You can simply run the benchmark as follows:

```terminal
$ ruby bench_iteration.rb
+--------+-----------------------------------------------+
| :bench | :measure                                      |
+--------+-----------------------------------------------+
| :for   |   0.010000   0.000000   0.010000 (  0.010454) |
| :times |   0.000000   0.000000   0.000000 (  0.002448) |
| :upto  |   0.000000   0.000000   0.000000 (  0.002451) |
+--------+-----------------------------------------------+
```
## Comparing rubies

What if we want to compare rubies? The Benchmark approach does not scale really well, comparing results becomes difficult. Bench has been designed so that moving forward to more complex benchmarking scenarios remains easy.

```ruby
require 'bench'         # !! we removed autorun here !!
n = 15000
Bench.runner do |r|
  r.variation_point :ruby, Bench.which_ruby
  r.report(:for)   { for i in 1..n; a = "1"; end }
  r.report(:times) { n.times do   ; a = "1"; end }
  r.report(:upto)  { 1.upto(n) do ; a = "1"; end }
end
```

Let's run it on a single ruby:

```terminal
$ bench run bench_iteration.rb
{:ruby => "ruby 1.9.2p290", :bench => :for, :tms => Bench::Tms(0.020000000000000018,0.0,0.0,0.0,0.012284517288208008)}
{:ruby => "ruby 1.9.2p290", :bench => :times, :tms => Bench::Tms(0.0,0.0,0.0,0.0,0.0024671554565429688)}
{:ruby => "ruby 1.9.2p290", :bench => :upto, :tms => Bench::Tms(0.0,0.0,0.0,0.0,0.0025177001953125)}
```
Let's run it on different rubies:

```terminal
$ rvm exec bench run bench_iteration.rb
{:ruby => "jruby 1.6.3", :bench => :for, :tms => Bench::Tms(0.0499999523162842,0.0,0.0,0.0,0.0499999523162842)}
{:ruby => "jruby 1.6.3", :bench => :times, :tms => Bench::Tms(0.0149998664855957,0.0,0.0,0.0,0.0149998664855957)}
{:ruby => "jruby 1.6.3", :bench => :upto, :tms => Bench::Tms(0.0120000839233398,0.0,0.0,0.0,0.0120000839233398)}
{:ruby => "ruby 1.8.7", :bench => :for, :tms => Bench::Tms(0.0,0.0,0.0,0.0,0.00345611572265625)}
{:ruby => "ruby 1.8.7", :bench => :times, :tms => Bench::Tms(0.01,0.0,0.0,0.0,0.00325107574462891)}
{:ruby => "ruby 1.8.7", :bench => :upto, :tms => Bench::Tms(0.0,0.0,0.0,0.0,0.00334000587463379)}
{:ruby => "ruby 1.9.2p290", :bench => :for, :tms => Bench::Tms(0.020000000000000018,0.0,0.0,0.0,0.012746095657348633)}
{:ruby => "ruby 1.9.2p290", :bench => :times, :tms => Bench::Tms(0.0,0.0,0.0,0.0,0.002442598342895508)}
{:ruby => "ruby 1.9.2p290", :bench => :upto, :tms => Bench::Tms(0.0,0.0,0.0,0.0,0.002568483352661133)}
{:ruby => "ruby 1.9.3dev", :bench => :for, :tms => Bench::Tms(0.0,0.0,0.0,0.0,0.0024805068969726562)}
{:ruby => "ruby 1.9.3dev", :bench => :times, :tms => Bench::Tms(0.010000000000000009,0.0,0.0,0.0,0.007232666015625)}
{:ruby => "ruby 1.9.3dev", :bench => :upto, :tms => Bench::Tms(0.010000000000000009,0.0,0.0,0.0,0.008184194564819336)}
```
Ok. The 'bench show' takes such kind of input, and let you regroup and compare results easily:

```terminal
$ rvm exec bench run bench_iteration.rb | bench show --hierarchy --regroup=ruby,bench
+----------------+------------------------------------------------------------+
| :ruby          | :measure                                                   |
+----------------+------------------------------------------------------------+
| jruby 1.6.3    | +--------+-----------------------------------------------+ |
|                | | :bench | :measure                                      | |
|                | +--------+-----------------------------------------------+ |
|                | | :for   |   0.098000   0.000000   0.098000 (  0.098000) | |
|                | | :times |   0.044000   0.000000   0.044000 (  0.044000) | |
|                | | :upto  |   0.028000   0.000000   0.028000 (  0.028000) | |
|                | +--------+-----------------------------------------------+ |
| ruby 1.8.7     | +--------+-----------------------------------------------+ |
|                | | :bench | :measure                                      | |
|                | +--------+-----------------------------------------------+ |
|                | | :for   |   0.020000   0.000000   0.020000 (  0.009876) | |
|                | | :times |   0.000000   0.000000   0.000000 (  0.003214) | |
|                | | :upto  |   0.000000   0.000000   0.000000 (  0.003860) | |
|                | +--------+-----------------------------------------------+ |
| ruby 1.9.2p290 | +--------+-----------------------------------------------+ |
|                | | :bench | :measure                                      | |
|                | +--------+-----------------------------------------------+ |
|                | | :for   |   0.010000   0.000000   0.010000 (  0.010615) | |
|                | | :times |   0.010000   0.000000   0.010000 (  0.002479) | |
|                | | :upto  |   0.000000   0.000000   0.000000 (  0.002511) | |
|                | +--------+-----------------------------------------------+ |
| ruby 1.9.3dev  | +--------+-----------------------------------------------+ |
|                | | :bench | :measure                                      | |
|                | +--------+-----------------------------------------------+ |
|                | | :for   |   0.005000   0.000000   0.005000 (  0.004987) | |
|                | | :times |   0.000000   0.000000   0.000000 (  0.002628) | |
|                | | :upto  |   0.005000   0.000000   0.005000 (  0.005142) | |
|                | +--------+-----------------------------------------------+ |
+----------------+------------------------------------------------------------+
```

```terminal
$ rvm exec bench run bench_iteration.rb | bench show --hierarchy --regroup=bench,ruby
+--------+--------------------------------------------------------------------+
| :bench | :measure                                                           |
+--------+--------------------------------------------------------------------+
| :for   | +----------------+-----------------------------------------------+ |
|        | | :ruby          | :measure                                      | |
|        | +----------------+-----------------------------------------------+ |
|        | | jruby 1.6.3    |   0.071000   0.000000   0.071000 (  0.071000) | |
|        | | ruby 1.8.7     |   0.010000   0.000000   0.010000 (  0.009677) | |
|        | | ruby 1.9.2p290 |   0.010000   0.000000   0.010000 (  0.010546) | |
|        | | ruby 1.9.3dev  |   0.005000   0.000000   0.005000 (  0.005175) | |
|        | +----------------+-----------------------------------------------+ |
| :times | +----------------+-----------------------------------------------+ |
|        | | :ruby          | :measure                                      | |
|        | +----------------+-----------------------------------------------+ |
|        | | jruby 1.6.3    |   0.028000   0.000000   0.028000 (  0.028000) | |
|        | | ruby 1.8.7     |   0.000000   0.000000   0.000000 (  0.003275) | |
|        | | ruby 1.9.2p290 |   0.000000   0.000000   0.000000 (  0.002549) | |
|        | | ruby 1.9.3dev  |   0.005000   0.000000   0.005000 (  0.002634) | |
|        | +----------------+-----------------------------------------------+ |
| :upto  | +----------------+-----------------------------------------------+ |
|        | | :ruby          | :measure                                      | |
|        | +----------------+-----------------------------------------------+ |
|        | | jruby 1.6.3    |   0.006000   0.000000   0.006000 (  0.006000) | |
|        | | ruby 1.8.7     |   0.000000   0.000000   0.000000 (  0.003254) | |
|        | | ruby 1.9.2p290 |   0.000000   0.000000   0.000000 (  0.002544) | |
|        | | ruby 1.9.3dev  |   0.010000   0.000000   0.010000 (  0.005230) | |
|        | +----------------+-----------------------------------------------+ |
+--------+--------------------------------------------------------------------+
```

